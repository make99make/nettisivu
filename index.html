<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <title>Raporttilomake</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial; max-width: 700px; margin: 2rem auto; background: #f4f4f4; padding: 2rem; }
    input, textarea, select { width: 100%; margin-bottom: 1rem; padding: 0.5rem; }
    button { padding: 0.5rem 1rem; margin-right: 1rem; }
  </style>
</head>
<body>
  <h1>Salaoja- ja viemÃ¤ritutkimus</h1>

  <input type="text" id="kohde" placeholder="Kohteen nimi">
  <input type="text" id="osoite" placeholder="Osoite">
  <input type="date" id="paiva">
  <input type="text" id="tutkija" placeholder="Tutkija">
  <textarea id="tarkoitus" placeholder="Tutkimuksen tarkoitus"></textarea>

  <select id="menetelma">
    <option>Kamerakuvaus</option>
    <option>ViemÃ¤rien huuhtelu</option>
    <option>Salaojien avaaminen</option>
    <option>Laserkaltevuusmittaus</option>
  </select>

  <textarea id="havainnot" placeholder="Havainnot"></textarea>
  <textarea id="suositukset" placeholder="Suositukset"></textarea>

  <input type="email" id="email" placeholder="SÃ¤hkÃ¶postiosoitteesi raporttiin">

  <button onclick="tallenna()">ğŸ’¾ Tallenna Firebaseen</button>
  <button onclick="viePDF()">ğŸ“„ Vie PDF</button>
  <button onclick="lahetaSahkopostiIlmanLiitetta()">ğŸ“§ LÃ¤hetÃ¤ sÃ¤hkÃ¶posti (ilman liitettÃ¤)</button>
  <button onclick="lahetaSahkopostiLiitteella()">ğŸ“§ LÃ¤hetÃ¤ sÃ¤hkÃ¶posti (liitteellÃ¤)</button>

  <!-- âœ… EmailJS SDK -->
  <script type="module">
    import * as emailjs from 'https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js';

    emailjs.init("UgTsc22XOYOLJqdur"); // â† sinun public key
    window.emailjs = emailjs; // tehdÃ¤Ã¤n saataville toisessa scriptissÃ¤
  </script>

  <!-- âœ… Firebase + toiminnot -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCdiaGQQz0roX8nz-qLdp6R8xrWSpr4Aio",
      authDomain: "salaojaraportti.firebaseapp.com",
      projectId: "salaojaraportti",
      storageBucket: "salaojaraportti.appspot.com",
      messagingSenderId: "818436123380",
      appId: "1:818436123380:web:7e90731c30402f71e50ca1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const kentat = ["kohde", "osoite", "paiva", "tutkija", "tarkoitus", "menetelma", "havainnot", "suositukset", "email"];

    function tallenna() {
      const data = {};
      kentat.forEach(id => data[id] = document.getElementById(id).value);
      db.collection("raportit").add(data)
        .then(() => alert("Tallennettu Firebaseen"))
        .catch(err => alert("Virhe tallennuksessa: " + err));
    }

    async function viePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 10;
      kentat.forEach(id => {
        const val = document.getElementById(id).value;
        doc.text(`${id}: ${val}`, 10, y);
        y += 10;
      });
      doc.save("raportti.pdf");
    }

    async function getPdfBase64() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 10;
      kentat.forEach(id => {
        const val = document.getElementById(id).value;
        doc.text(`${id}: ${val}`, 10, y);
        y += 10;
      });
      return doc.output("datauristring"); // sisÃ¤ltÃ¤Ã¤: data:application/pdf;base64,...
    }

    async function lahetaSahkopostiIlmanLiitetta() {
      const data = {};
      kentat.forEach(id => data[id] = document.getElementById(id).value);

      emailjs.send("service_jk8fxlu", "template_m9rvwws", data)
        .then(response => {
          console.log("SÃ¤hkÃ¶posti lÃ¤hetetty:", response.status, response.text);
          alert("SÃ¤hkÃ¶posti lÃ¤hetetty ilman liitettÃ¤!");
        })
        .catch(error => {
          console.error("Virhe sÃ¤hkÃ¶postin lÃ¤hetyksessÃ¤:", error);
          alert("SÃ¤hkÃ¶postin lÃ¤hetys epÃ¤onnistui: " + (error.text || error));
        });
    }

    async function lahetaSahkopostiLiitteella() {
      const data = {};
      kentat.forEach(id => data[id] = document.getElementById(id).value);

      const pdfBase64 = await getPdfBase64();

      // Poistetaan "data:application/pdf;base64," alku base64-datasta
      const base64Data = pdfBase64.split(',')[1];

      const params = {
        ...data,
        attachments: [
          {
            name: "raportti.pdf",
            data: base64Data,
            encoding: "base64"
          }
        ]
      };

      emailjs.send("service_jk8fxlu", "template_m9rvwws", params)
        .then(response => {
          console.log("SÃ¤hkÃ¶posti liitteellÃ¤ lÃ¤hetetty:", response.status, response.text);
          alert("SÃ¤hkÃ¶posti lÃ¤hetetty liitteellÃ¤!");
        })
        .catch(error => {
          console.error("Virhe sÃ¤hkÃ¶postin lÃ¤hetyksessÃ¤ liitteellÃ¤:", error);
          alert("SÃ¤hkÃ¶postin lÃ¤hetys liitteellÃ¤ epÃ¤onnistui: " + (error.text || error));
        });
    }
  </script>
</body>
</html>

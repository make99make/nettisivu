<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <title>Raporttilomake</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial; max-width: 700px; margin: 2rem auto; background: #f4f4f4; padding: 2rem; }
    input, textarea, select { width: 100%; margin-bottom: 1rem; padding: 0.5rem; }
    button { padding: 0.5rem 1rem; margin-right: 1rem; }
    small#status { display: block; margin-top: 1rem; color: #555; font-style: italic; }
  </style>
</head>
<body>
  <h1>Salaoja- ja viemäritutkimus</h1>

  <input type="text" id="kohde" placeholder="Kohteen nimi">
  <input type="text" id="osoite" placeholder="Osoite">
  <input type="date" id="paiva">
  <input type="text" id="tutkija" placeholder="Tutkija">
  <textarea id="tarkoitus" placeholder="Tutkimuksen tarkoitus"></textarea>

  <select id="menetelma">
    <option>Kamerakuvaus</option>
    <option>Viemärien huuhtelu</option>
    <option>Salaojien avaaminen</option>
    <option>Laserkaltevuusmittaus</option>
  </select>

  <textarea id="havainnot" placeholder="Havainnot"></textarea>
  <textarea id="suositukset" placeholder="Suositukset"></textarea>

  <input type="email" id="email" placeholder="Sähköpostiosoitteesi raporttiin">

  <button onclick="tallenna()">💾 Tallenna Firebaseen</button>
  <button onclick="viePDF()">📄 Vie PDF</button>
  <button onclick="lahetaSahkoposti()">📧 Lähetä sähköposti</button>

  <small id="status"></small>

  <!-- ✅ EmailJS SDK -->
  <script type="module">
    import emailjs from 'https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js';

    emailjs.init("UgTsc22XOYOLJqdur"); // ← sinun public key
    window.emailjs = emailjs; // tehdään saataville toisessa scriptissä
  </script>

  <!-- ✅ Firebase + toiminnot -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCdiaGQQz0roX8nz-qLdp6R8xrWSpr4Aio",
      authDomain: "salaojaraportti.firebaseapp.com",
      projectId: "salaojaraportti",
      storageBucket: "salaojaraportti.appspot.com",
      messagingSenderId: "818436123380",
      appId: "1:818436123380:web:7e90731c30402f71e50ca1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const kentat = ["kohde", "osoite", "paiva", "tutkija", "tarkoitus", "menetelma", "havainnot", "suositukset", "email"];

    function validoi() {
      for (let id of kentat) {
        const val = document.getElementById(id).value.trim();
        if (!val) {
          alert(`Kenttä "${id}" on pakollinen.`);
          return false;
        }
      }
      return true;
    }

    function tallenna() {
      if (!validoi()) return;
      const data = {};
      kentat.forEach(id => data[id] = document.getElementById(id).value);
      db.collection("raportit").add(data)
        .then(() => {
          alert("Tallennettu Firebaseen");
          document.getElementById("status").textContent = "Raportti tallennettu tietokantaan.";
        })
        .catch(err => {
          alert("Virhe tallennuksessa: " + err);
          document.getElementById("status").textContent = "Tallennus epäonnistui.";
        });
    }

    async function viePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 10;
      kentat.forEach(id => {
        const val = document.getElementById(id).value;
        doc.text(`${id}: ${val}`, 10, y);
        y += 10;
      });
      doc.save("raportti.pdf");
      document.getElementById("status").textContent = "PDF tallennettu koneellesi.";
    }

    async function getPdfBase64() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 10;
      kentat.forEach(id => {
        const val = document.getElementById(id).value;
        doc.text(`${id}: ${val}`, 10, y);
        y += 10;
      });
      return doc.output("datauristring");
    }

    async function lahetaSahkoposti() {
      if (!validoi()) return;

      const data = {};
      kentat.forEach(id => data[id] = document.getElementById(id).value);

      document.getElementById("status").textContent = "Luodaan PDF ja lähetetään sähköposti...";

      const pdfBase64 = await getPdfBase64();
      const params = {
        ...data,
        attachment: pdfBase64
      };

      emailjs.send("service_jk8fxlu", "template_m9rvwws", params)
        .then(() => {
          alert("Sähköposti lähetetty liitteellä");
          document.getElementById("status").textContent = "Sähköposti lähetetty onnistuneesti.";
        })
        .catch(err => {
          alert("Virhe: " + err);
          document.getElementById("status").textContent = "Sähköpostin lähetys epäonnistui.";
        });
    }
  </script>
</body>
</html>
